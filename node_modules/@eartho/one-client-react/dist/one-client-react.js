(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('react')) :
    typeof define === 'function' && define.amd ? define(['exports', 'react'], factory) :
    (global = typeof globalThis !== 'undefined' ? globalThis : global || self, factory(global.reactEartho = {}, global.React));
})(this, (function (exports, React) { 'use strict';

    /******************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */
    /* global Reflect, Promise, SuppressedError, Symbol */

    var extendStatics = function(d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };

    function __extends(d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    }

    var __assign = function() {
        __assign = Object.assign || function __assign(t) {
            for (var s, i = 1, n = arguments.length; i < n; i++) {
                s = arguments[i];
                for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];
            }
            return t;
        };
        return __assign.apply(this, arguments);
    };

    function __rest$1(s, e) {
        var t = {};
        for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
            t[p] = s[p];
        if (s != null && typeof Object.getOwnPropertySymbols === "function")
            for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
                if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                    t[p[i]] = s[p[i]];
            }
        return t;
    }

    function __awaiter(thisArg, _arguments, P, generator) {
        function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
        return new (P || (P = Promise))(function (resolve, reject) {
            function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
            function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
            function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
            step((generator = generator.apply(thisArg, _arguments || [])).next());
        });
    }

    function __generator(thisArg, body) {
        var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
        return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
        function verb(n) { return function (v) { return step([n, v]); }; }
        function step(op) {
            if (f) throw new TypeError("Generator is already executing.");
            while (g && (g = 0, op[0] && (_ = 0)), _) try {
                if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
                if (y = 0, t) op = [op[0] & 2, t.value];
                switch (op[0]) {
                    case 0: case 1: t = op; break;
                    case 4: _.label++; return { value: op[1], done: false };
                    case 5: _.label++; y = op[1]; op = [0]; continue;
                    case 7: op = _.ops.pop(); _.trys.pop(); continue;
                    default:
                        if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                        if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                        if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                        if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                        if (t[2]) _.ops.pop();
                        _.trys.pop(); continue;
                }
                op = body.call(thisArg, _);
            } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
            if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
        }
    }

    typeof SuppressedError === "function" ? SuppressedError : function (error, suppressed, message) {
        var e = new Error(message);
        return e.name = "SuppressedError", e.error = error, e.suppressed = suppressed, e;
    };

    function __rest(s,e){var t={};for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0)t[p]=s[p];if(s!=null&&typeof Object.getOwnPropertySymbols==="function")for(var i=0,p=Object.getOwnPropertySymbols(s);i<p.length;i++){if(e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i]))t[p[i]]=s[p[i]];}return t}typeof SuppressedError==="function"?SuppressedError:function(error,suppressed,message){var e=new Error(message);return e.name="SuppressedError",e.error=error,e.suppressed=suppressed,e};var commonjsGlobal=typeof globalThis!=="undefined"?globalThis:typeof window!=="undefined"?window:typeof global!=="undefined"?global:typeof self!=="undefined"?self:{};function unwrapExports(x){return x&&x.__esModule&&Object.prototype.hasOwnProperty.call(x,"default")?x["default"]:x}function createCommonjsModule(fn,module){return module={exports:{}},fn(module,module.exports),module.exports}var processLock=createCommonjsModule((function(module,exports){Object.defineProperty(exports,"__esModule",{value:true});var ProcessLocking=function(){function ProcessLocking(){var _this=this;this.locked=new Map;this.addToLocked=function(key,toAdd){var callbacks=_this.locked.get(key);if(callbacks===undefined){if(toAdd===undefined){_this.locked.set(key,[]);}else {_this.locked.set(key,[toAdd]);}}else {if(toAdd!==undefined){callbacks.unshift(toAdd);_this.locked.set(key,callbacks);}}};this.isLocked=function(key){return _this.locked.has(key)};this.lock=function(key){return new Promise((function(resolve,reject){if(_this.isLocked(key)){_this.addToLocked(key,resolve);}else {_this.addToLocked(key);resolve();}}))};this.unlock=function(key){var callbacks=_this.locked.get(key);if(callbacks===undefined||callbacks.length===0){_this.locked.delete(key);return}var toCall=callbacks.pop();_this.locked.set(key,callbacks);if(toCall!==undefined){setTimeout(toCall,0);}};}ProcessLocking.getInstance=function(){if(ProcessLocking.instance===undefined){ProcessLocking.instance=new ProcessLocking;}return ProcessLocking.instance};return ProcessLocking}();function getLock(){return ProcessLocking.getInstance()}exports.default=getLock;}));unwrapExports(processLock);var browserTabsLock=createCommonjsModule((function(module,exports){var __awaiter=commonjsGlobal&&commonjsGlobal.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator["throw"](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):new P((function(resolve){resolve(result.value);})).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());}))};var __generator=commonjsGlobal&&commonjsGlobal.__generator||function(thisArg,body){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},f,y,t,g;return g={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=op[0]&2?y["return"]:op[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[op[0]&2,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return {value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue}if(op[0]===3&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break}if(t[2])_.ops.pop();_.trys.pop();continue}op=body.call(thisArg,_);}catch(e){op=[6,e];y=0;}finally{f=t=0;}if(op[0]&5)throw op[1];return {value:op[0]?op[1]:void 0,done:true}}};var _this=commonjsGlobal;Object.defineProperty(exports,"__esModule",{value:true});var LOCK_STORAGE_KEY="browser-tabs-lock-key";var DEFAULT_STORAGE_HANDLER={key:function(index){return __awaiter(_this,void 0,void 0,(function(){return __generator(this,(function(_a){throw new Error("Unsupported")}))}))},getItem:function(key){return __awaiter(_this,void 0,void 0,(function(){return __generator(this,(function(_a){throw new Error("Unsupported")}))}))},clear:function(){return __awaiter(_this,void 0,void 0,(function(){return __generator(this,(function(_a){return [2,window.localStorage.clear()]}))}))},removeItem:function(key){return __awaiter(_this,void 0,void 0,(function(){return __generator(this,(function(_a){throw new Error("Unsupported")}))}))},setItem:function(key,value){return __awaiter(_this,void 0,void 0,(function(){return __generator(this,(function(_a){throw new Error("Unsupported")}))}))},keySync:function(index){return window.localStorage.key(index)},getItemSync:function(key){return window.localStorage.getItem(key)},clearSync:function(){return window.localStorage.clear()},removeItemSync:function(key){return window.localStorage.removeItem(key)},setItemSync:function(key,value){return window.localStorage.setItem(key,value)}};function delay(milliseconds){return new Promise((function(resolve){return setTimeout(resolve,milliseconds)}))}function generateRandomString(length){var CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var randomstring="";for(var i=0;i<length;i++){var INDEX=Math.floor(Math.random()*CHARS.length);randomstring+=CHARS[INDEX];}return randomstring}function getLockId(){return Date.now().toString()+generateRandomString(15)}var SuperTokensLock=function(){function SuperTokensLock(storageHandler){this.acquiredIatSet=new Set;this.storageHandler=undefined;this.id=getLockId();this.acquireLock=this.acquireLock.bind(this);this.releaseLock=this.releaseLock.bind(this);this.releaseLock__private__=this.releaseLock__private__.bind(this);this.waitForSomethingToChange=this.waitForSomethingToChange.bind(this);this.refreshLockWhileAcquired=this.refreshLockWhileAcquired.bind(this);this.storageHandler=storageHandler;if(SuperTokensLock.waiters===undefined){SuperTokensLock.waiters=[];}}SuperTokensLock.prototype.acquireLock=function(lockKey,timeout){if(timeout===void 0){timeout=5e3;}return __awaiter(this,void 0,void 0,(function(){var iat,MAX_TIME,STORAGE_KEY,STORAGE,lockObj,TIMEOUT_KEY,lockObjPostDelay,parsedLockObjPostDelay;return __generator(this,(function(_a){switch(_a.label){case 0:iat=Date.now()+generateRandomString(4);MAX_TIME=Date.now()+timeout;STORAGE_KEY=LOCK_STORAGE_KEY+"-"+lockKey;STORAGE=this.storageHandler===undefined?DEFAULT_STORAGE_HANDLER:this.storageHandler;_a.label=1;case 1:if(!(Date.now()<MAX_TIME))return [3,8];return [4,delay(30)];case 2:_a.sent();lockObj=STORAGE.getItemSync(STORAGE_KEY);if(!(lockObj===null))return [3,5];TIMEOUT_KEY=this.id+"-"+lockKey+"-"+iat;return [4,delay(Math.floor(Math.random()*25))];case 3:_a.sent();STORAGE.setItemSync(STORAGE_KEY,JSON.stringify({id:this.id,iat:iat,timeoutKey:TIMEOUT_KEY,timeAcquired:Date.now(),timeRefreshed:Date.now()}));return [4,delay(30)];case 4:_a.sent();lockObjPostDelay=STORAGE.getItemSync(STORAGE_KEY);if(lockObjPostDelay!==null){parsedLockObjPostDelay=JSON.parse(lockObjPostDelay);if(parsedLockObjPostDelay.id===this.id&&parsedLockObjPostDelay.iat===iat){this.acquiredIatSet.add(iat);this.refreshLockWhileAcquired(STORAGE_KEY,iat);return [2,true]}}return [3,7];case 5:SuperTokensLock.lockCorrector(this.storageHandler===undefined?DEFAULT_STORAGE_HANDLER:this.storageHandler);return [4,this.waitForSomethingToChange(MAX_TIME)];case 6:_a.sent();_a.label=7;case 7:iat=Date.now()+generateRandomString(4);return [3,1];case 8:return [2,false]}}))}))};SuperTokensLock.prototype.refreshLockWhileAcquired=function(storageKey,iat){return __awaiter(this,void 0,void 0,(function(){var _this=this;return __generator(this,(function(_a){setTimeout((function(){return __awaiter(_this,void 0,void 0,(function(){var STORAGE,lockObj,parsedLockObj;return __generator(this,(function(_a){switch(_a.label){case 0:return [4,processLock.default().lock(iat)];case 1:_a.sent();if(!this.acquiredIatSet.has(iat)){processLock.default().unlock(iat);return [2]}STORAGE=this.storageHandler===undefined?DEFAULT_STORAGE_HANDLER:this.storageHandler;lockObj=STORAGE.getItemSync(storageKey);if(lockObj!==null){parsedLockObj=JSON.parse(lockObj);parsedLockObj.timeRefreshed=Date.now();STORAGE.setItemSync(storageKey,JSON.stringify(parsedLockObj));processLock.default().unlock(iat);}else {processLock.default().unlock(iat);return [2]}this.refreshLockWhileAcquired(storageKey,iat);return [2]}}))}))}),1e3);return [2]}))}))};SuperTokensLock.prototype.waitForSomethingToChange=function(MAX_TIME){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){switch(_a.label){case 0:return [4,new Promise((function(resolve){var resolvedCalled=false;var startedAt=Date.now();var MIN_TIME_TO_WAIT=50;var removedListeners=false;function stopWaiting(){if(!removedListeners){window.removeEventListener("storage",stopWaiting);SuperTokensLock.removeFromWaiting(stopWaiting);clearTimeout(timeOutId);removedListeners=true;}if(!resolvedCalled){resolvedCalled=true;var timeToWait=MIN_TIME_TO_WAIT-(Date.now()-startedAt);if(timeToWait>0){setTimeout(resolve,timeToWait);}else {resolve(null);}}}window.addEventListener("storage",stopWaiting);SuperTokensLock.addToWaiting(stopWaiting);var timeOutId=setTimeout(stopWaiting,Math.max(0,MAX_TIME-Date.now()));}))];case 1:_a.sent();return [2]}}))}))};SuperTokensLock.addToWaiting=function(func){this.removeFromWaiting(func);if(SuperTokensLock.waiters===undefined){return}SuperTokensLock.waiters.push(func);};SuperTokensLock.removeFromWaiting=function(func){if(SuperTokensLock.waiters===undefined){return}SuperTokensLock.waiters=SuperTokensLock.waiters.filter((function(i){return i!==func}));};SuperTokensLock.notifyWaiters=function(){if(SuperTokensLock.waiters===undefined){return}var waiters=SuperTokensLock.waiters.slice();waiters.forEach((function(i){return i()}));};SuperTokensLock.prototype.releaseLock=function(lockKey){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){switch(_a.label){case 0:return [4,this.releaseLock__private__(lockKey)];case 1:return [2,_a.sent()]}}))}))};SuperTokensLock.prototype.releaseLock__private__=function(lockKey){return __awaiter(this,void 0,void 0,(function(){var STORAGE,STORAGE_KEY,lockObj,parsedlockObj;return __generator(this,(function(_a){switch(_a.label){case 0:STORAGE=this.storageHandler===undefined?DEFAULT_STORAGE_HANDLER:this.storageHandler;STORAGE_KEY=LOCK_STORAGE_KEY+"-"+lockKey;lockObj=STORAGE.getItemSync(STORAGE_KEY);if(lockObj===null){return [2]}parsedlockObj=JSON.parse(lockObj);if(!(parsedlockObj.id===this.id))return [3,2];return [4,processLock.default().lock(parsedlockObj.iat)];case 1:_a.sent();this.acquiredIatSet.delete(parsedlockObj.iat);STORAGE.removeItemSync(STORAGE_KEY);processLock.default().unlock(parsedlockObj.iat);SuperTokensLock.notifyWaiters();_a.label=2;case 2:return [2]}}))}))};SuperTokensLock.lockCorrector=function(storageHandler){var MIN_ALLOWED_TIME=Date.now()-5e3;var STORAGE=storageHandler;var KEYS=[];var currIndex=0;while(true){var key=STORAGE.keySync(currIndex);if(key===null){break}KEYS.push(key);currIndex++;}var notifyWaiters=false;for(var i=0;i<KEYS.length;i++){var LOCK_KEY=KEYS[i];if(LOCK_KEY.includes(LOCK_STORAGE_KEY)){var lockObj=STORAGE.getItemSync(LOCK_KEY);if(lockObj!==null){var parsedlockObj=JSON.parse(lockObj);if(parsedlockObj.timeRefreshed===undefined&&parsedlockObj.timeAcquired<MIN_ALLOWED_TIME||parsedlockObj.timeRefreshed!==undefined&&parsedlockObj.timeRefreshed<MIN_ALLOWED_TIME){STORAGE.removeItemSync(LOCK_KEY);notifyWaiters=true;}}}}if(notifyWaiters){SuperTokensLock.notifyWaiters();}};SuperTokensLock.waiters=undefined;return SuperTokensLock}();exports.default=SuperTokensLock;}));var Lock=unwrapExports(browserTabsLock);var version="2.1.3";const DEFAULT_AUTHORIZE_TIMEOUT_IN_SECONDS=600;const DEFAULT_POPUP_CONFIG_OPTIONS={timeoutInSeconds:DEFAULT_AUTHORIZE_TIMEOUT_IN_SECONDS};const DEFAULT_SILENT_TOKEN_RETRY_COUNT=3;const CLEANUP_IFRAME_TIMEOUT_IN_SECONDS=2;const DEFAULT_FETCH_TIMEOUT_MS=1e4;const CACHE_LOCATION_MEMORY="memory";const CACHE_LOCATION_LOCAL_STORAGE="localstorage";const MISSING_REFRESH_TOKEN_ERROR_MESSAGE="Missing Refresh Token";const INVALID_REFRESH_TOKEN_ERROR_MESSAGE="invalid refresh token";const DEFAULT_SCOPE="openid profile email";const DEFAULT_SESSION_CHECK_EXPIRY_DAYS=1;const DEFAULT_EARTHO_CLIENT={name:"one-client-js",version:version};const DEFAULT_NOW_PROVIDER=()=>Date.now();class GenericError extends Error{constructor(error,error_description){super(error_description);this.error=error;this.error_description=error_description;Object.setPrototypeOf(this,GenericError.prototype);}static fromPayload({error:error,error_description:error_description}){return new GenericError(error,error_description)}}class AuthenticationError extends GenericError{constructor(error,error_description,state,appState=null){super(error,error_description);this.state=state;this.appState=appState;Object.setPrototypeOf(this,AuthenticationError.prototype);}}class TimeoutError extends GenericError{constructor(){super("timeout","Timeout");Object.setPrototypeOf(this,TimeoutError.prototype);}}class PopupTimeoutError extends TimeoutError{constructor(popup){super();this.popup=popup;Object.setPrototypeOf(this,PopupTimeoutError.prototype);}}class PopupCancelledError extends GenericError{constructor(popup){super("cancelled","Popup closed");this.popup=popup;Object.setPrototypeOf(this,PopupCancelledError.prototype);}}class MfaRequiredError extends GenericError{constructor(error,error_description,mfa_token){super(error,error_description);this.mfa_token=mfa_token;Object.setPrototypeOf(this,MfaRequiredError.prototype);}}class MissingRefreshTokenError extends GenericError{constructor(audience,scope){super("missing_refresh_token",`Missing Refresh Token (audience: '${valueOrEmptyString(audience,["default"])}', scope: '${valueOrEmptyString(scope)}')`);this.audience=audience;this.scope=scope;Object.setPrototypeOf(this,MissingRefreshTokenError.prototype);}}function valueOrEmptyString(value,exclude=[]){return value&&!exclude.includes(value)?value:""}const parseAuthenticationResult=queryString=>{if(queryString.indexOf("#")>-1){queryString=queryString.substring(0,queryString.indexOf("#"));}const searchParams=new URLSearchParams(queryString);return {state:searchParams.get("state"),code:searchParams.get("code")||undefined,error:searchParams.get("error")||undefined,error_description:searchParams.get("error_description")||undefined}};const runIframe=(authorizeUrl,eventOrigin,timeoutInSeconds=DEFAULT_AUTHORIZE_TIMEOUT_IN_SECONDS)=>new Promise(((res,rej)=>{const iframe=window.document.createElement("iframe");iframe.setAttribute("width","0");iframe.setAttribute("height","0");iframe.style.display="none";const removeIframe=()=>{if(window.document.body.contains(iframe)){window.document.body.removeChild(iframe);window.removeEventListener("message",iframeEventHandler,false);}};let iframeEventHandler;const timeoutSetTimeoutId=setTimeout((()=>{rej(new TimeoutError);removeIframe();}),timeoutInSeconds*1e3);iframeEventHandler=function(e){if(e.origin!=eventOrigin)return;if(!e.data||e.data.type!=="authorization_response")return;const eventSource=e.source;if(eventSource){eventSource.close();}e.data.response.error?rej(GenericError.fromPayload(e.data.response)):res(e.data.response);clearTimeout(timeoutSetTimeoutId);window.removeEventListener("message",iframeEventHandler,false);setTimeout(removeIframe,CLEANUP_IFRAME_TIMEOUT_IN_SECONDS*1e3);};window.addEventListener("message",iframeEventHandler,false);window.document.body.appendChild(iframe);iframe.setAttribute("src",authorizeUrl);}));const openPopup=url=>{const width=400;const height=600;const left=window.screenX+(window.innerWidth-width)/2;const top=window.screenY+(window.innerHeight-height)/2;return window.open(url,"eartho:authorize:popup",`left=${left},top=${top},width=${width},height=${height},resizable,scrollbars=yes,status=1`)};const runPopup=config=>new Promise(((resolve,reject)=>{let popupEventListener;const popupTimer=setInterval((()=>{if(config.popup&&config.popup.closed){clearInterval(popupTimer);clearTimeout(timeoutId);window.removeEventListener("message",popupEventListener,false);reject(new PopupCancelledError(config.popup));}}),1e3);const timeoutId=setTimeout((()=>{clearInterval(popupTimer);reject(new PopupTimeoutError(config.popup));window.removeEventListener("message",popupEventListener,false);}),(config.timeoutInSeconds||DEFAULT_AUTHORIZE_TIMEOUT_IN_SECONDS)*1e3);popupEventListener=function(e){if(!e.data||e.data.type!=="authorization_response"){return}clearTimeout(timeoutId);clearInterval(popupTimer);window.removeEventListener("message",popupEventListener,false);config.popup.close();if(e.data.response.error){return reject(GenericError.fromPayload(e.data.response))}resolve(e.data.response);};window.addEventListener("message",popupEventListener);}));const getCrypto=()=>window.crypto;const createRandomString=()=>{const charset="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_~.";let random="";const randomValues=Array.from(getCrypto().getRandomValues(new Uint8Array(43)));randomValues.forEach((v=>random+=charset[v%charset.length]));return random};const encode=value=>btoa(value);const stripUndefined=params=>Object.keys(params).filter((k=>typeof params[k]!=="undefined")).reduce(((acc,key)=>Object.assign(Object.assign({},acc),{[key]:params[key]})),{});const createQueryParams=_a=>{var{clientId:client_id}=_a,params=__rest(_a,["clientId"]);return new URLSearchParams(stripUndefined(Object.assign({client_id:client_id},params))).toString()};const sha256=async s=>{const digestOp=getCrypto().subtle.digest({name:"SHA-256"},(new TextEncoder).encode(s));return await digestOp};const urlEncodeB64=input=>{const b64Chars={"+":"-","/":"_","=":""};return input.replace(/[+/=]/g,(m=>b64Chars[m]))};const decodeB64=input=>decodeURIComponent(atob(input).split("").map((c=>"%"+("00"+c.charCodeAt(0).toString(16)).slice(-2))).join(""));const urlDecodeB64=input=>decodeB64(input.replace(/_/g,"/").replace(/-/g,"+"));const bufferToBase64UrlEncoded=input=>{const ie11SafeInput=new Uint8Array(input);return urlEncodeB64(window.btoa(String.fromCharCode(...Array.from(ie11SafeInput))))};const validateCrypto=()=>{if(!getCrypto()){throw new Error("For security reasons, `window.crypto` is required to run `one-client-js`.")}if(typeof getCrypto().subtle==="undefined"){throw new Error(`\n      one-client-js must run on a secure origin.\n    `)}};const getDomain=domainUrl=>{if(!/^https?:\/\//.test(domainUrl)){return `https://${domainUrl}`}return domainUrl};const getTokenIssuer=(issuer,domainUrl)=>{if(issuer){return issuer.startsWith("https://")?issuer:`https://${issuer}/`}return `${domainUrl}/`};const parseNumber=value=>{if(typeof value!=="string"){return value}return parseInt(value,10)||undefined};const sendMessage=(message,to)=>new Promise((function(resolve,reject){const messageChannel=new MessageChannel;messageChannel.port1.onmessage=function(event){if(event.data.error){reject(new Error(event.data.error));}else {resolve(event.data);}messageChannel.port1.close();};to.postMessage(message,[messageChannel.port2]);}));const createAbortController=()=>new AbortController;const dofetch=async(fetchUrl,fetchOptions)=>{const response=await fetch(fetchUrl,fetchOptions);return {ok:response.ok,json:await response.json()}};const fetchWithoutWorker=async(fetchUrl,fetchOptions,timeout)=>{const controller=createAbortController();fetchOptions.signal=controller.signal;let timeoutId;return Promise.race([dofetch(fetchUrl,fetchOptions),new Promise(((_,reject)=>{timeoutId=setTimeout((()=>{controller.abort();reject(new Error("Timeout when executing 'fetch'"));}),timeout);}))]).finally((()=>{clearTimeout(timeoutId);}))};const fetchWithWorker=async(fetchUrl,audience,scope,fetchOptions,timeout,worker,useFormData)=>sendMessage({auth:{audience:audience,scope:scope},timeout:timeout,fetchUrl:fetchUrl,fetchOptions:fetchOptions,useFormData:useFormData},worker);const switchFetch=async(fetchUrl,audience,scope,fetchOptions,worker,useFormData,timeout=DEFAULT_FETCH_TIMEOUT_MS)=>{if(worker){return fetchWithWorker(fetchUrl,audience,scope,fetchOptions,timeout,worker,useFormData)}else {return fetchWithoutWorker(fetchUrl,fetchOptions,timeout)}};async function getJSON(url,timeout,audience,scope,options,worker,useFormData){let fetchError=null;let response;for(let i=0;i<DEFAULT_SILENT_TOKEN_RETRY_COUNT;i++){try{response=await switchFetch(url,audience,scope,options,worker,useFormData,timeout);fetchError=null;break}catch(e){fetchError=e;}}if(fetchError){throw fetchError}const _a=response.json,{error:error,error_description:error_description}=_a,data=__rest(_a,["error","error_description"]),{ok:ok}=response;if(!ok){const errorMessage=error_description||`HTTP error. Unable to fetch ${url}`;if(error==="mfa_required"){throw new MfaRequiredError(error,errorMessage,data.mfa_token)}if(error==="missing_refresh_token"){throw new MissingRefreshTokenError(audience,scope)}throw new GenericError(error||"request_error",errorMessage)}return data}async function oauthToken(_a,worker){var{baseUrl:baseUrl,timeout:timeout,audience:audience,scope:scope,earthoOneClient:earthoOneClient,useFormData:useFormData}=_a,options=__rest(_a,["baseUrl","timeout","audience","scope","earthoOneClient","useFormData"]);const body=useFormData?createQueryParams(options):JSON.stringify(options);return await getJSON(`${baseUrl}/access/oauth/token`,timeout,audience||"default",scope,{method:"POST",body:body,headers:{"Content-Type":useFormData?"application/x-www-form-urlencoded":"application/json","Eartho-Client":btoa(JSON.stringify(earthoOneClient||DEFAULT_EARTHO_CLIENT))}},worker,useFormData)}const dedupe=arr=>Array.from(new Set(arr));const getUniqueScopes=(...scopes)=>dedupe(scopes.filter(Boolean).join(" ").trim().split(/\s+/)).join(" ");const CACHE_KEY_PREFIX="@@oneclientjs@@";const CACHE_KEY_ID_TOKEN_SUFFIX="@@user@@";class CacheKey{constructor(data,prefix=CACHE_KEY_PREFIX,suffix){this.prefix=prefix;this.suffix=suffix;this.clientId=data.clientId;this.scope=data.scope;this.audience=data.audience;}toKey(){return [this.prefix,this.clientId,this.audience,this.scope,this.suffix].filter(Boolean).join("::")}static fromKey(key){const[prefix,clientId,audience,scope]=key.split("::");return new CacheKey({clientId:clientId,scope:scope,audience:audience},prefix)}static fromCacheEntry(entry){const{scope:scope,audience:audience,client_id:clientId}=entry;return new CacheKey({scope:scope,audience:audience,clientId:clientId})}}class LocalStorageCache{set(key,entry){localStorage.setItem(key,JSON.stringify(entry));}get(key){const json=window.localStorage.getItem(key);if(!json)return;try{const payload=JSON.parse(json);return payload}catch(e){return}}remove(key){localStorage.removeItem(key);}allKeys(){return Object.keys(window.localStorage).filter((key=>key.startsWith(CACHE_KEY_PREFIX)))}}class InMemoryCache{constructor(){this.enclosedCache=function(){let cache={};return {set(key,entry){cache[key]=entry;},get(key){const cacheEntry=cache[key];if(!cacheEntry){return}return cacheEntry},remove(key){delete cache[key];},allKeys(){return Object.keys(cache)}}}();}}const DEFAULT_EXPIRY_ADJUSTMENT_SECONDS=0;class CacheManager{constructor(cache,keyManifest,nowProvider){this.cache=cache;this.keyManifest=keyManifest;this.nowProvider=nowProvider||DEFAULT_NOW_PROVIDER;}async setIdToken(clientId,idToken,decodedToken){var _a;const cacheKey=this.getIdTokenCacheKey(clientId);await this.cache.set(cacheKey,{id_token:idToken,decodedToken:decodedToken});await((_a=this.keyManifest)===null||_a===void 0?void 0:_a.add(cacheKey));}async getIdToken(cacheKey){const entry=await this.cache.get(this.getIdTokenCacheKey(cacheKey.clientId));if(!entry&&cacheKey.scope&&cacheKey.audience){const entryByScope=await this.get(cacheKey);if(!entryByScope){return}if(!entryByScope.id_token||!entryByScope.decodedToken){return}return {id_token:entryByScope.id_token,decodedToken:entryByScope.decodedToken}}if(!entry){return}return {id_token:entry.id_token,decodedToken:entry.decodedToken}}async get(cacheKey,expiryAdjustmentSeconds=DEFAULT_EXPIRY_ADJUSTMENT_SECONDS){var _a;let wrappedEntry=await this.cache.get(cacheKey.toKey());if(!wrappedEntry){const keys=await this.getCacheKeys();if(!keys)return;const matchedKey=this.matchExistingCacheKey(cacheKey,keys);if(matchedKey){wrappedEntry=await this.cache.get(matchedKey);}}if(!wrappedEntry){return}const now=await this.nowProvider();const nowSeconds=Math.floor(now/1e3);if(wrappedEntry.expiresAt-expiryAdjustmentSeconds<nowSeconds){if(wrappedEntry.body.refresh_token){wrappedEntry.body={refresh_token:wrappedEntry.body.refresh_token};await this.cache.set(cacheKey.toKey(),wrappedEntry);return wrappedEntry.body}await this.cache.remove(cacheKey.toKey());await((_a=this.keyManifest)===null||_a===void 0?void 0:_a.remove(cacheKey.toKey()));return}return wrappedEntry.body}async set(entry){var _a;const cacheKey=new CacheKey({clientId:entry.client_id,scope:entry.scope,audience:entry.audience});const wrappedEntry=await this.wrapCacheEntry(entry);await this.cache.set(cacheKey.toKey(),wrappedEntry);await((_a=this.keyManifest)===null||_a===void 0?void 0:_a.add(cacheKey.toKey()));}async clear(clientId){var _a;const keys=await this.getCacheKeys();if(!keys)return;await keys.filter((key=>clientId?key.includes(clientId):true)).reduce((async(memo,key)=>{await memo;await this.cache.remove(key);}),Promise.resolve());await((_a=this.keyManifest)===null||_a===void 0?void 0:_a.clear());}async wrapCacheEntry(entry){const now=await this.nowProvider();const expiresInTime=Math.floor(now/1e3)+entry.expires_in;return {body:entry,expiresAt:expiresInTime}}async getCacheKeys(){var _a;if(this.keyManifest){return (_a=await this.keyManifest.get())===null||_a===void 0?void 0:_a.keys}else if(this.cache.allKeys){return this.cache.allKeys()}}getIdTokenCacheKey(clientId){return new CacheKey({clientId:clientId},CACHE_KEY_PREFIX,CACHE_KEY_ID_TOKEN_SUFFIX).toKey()}matchExistingCacheKey(keyToMatch,allKeys){return allKeys.filter((key=>{var _a;const cacheKey=CacheKey.fromKey(key);const scopeSet=new Set(cacheKey.scope&&cacheKey.scope.split(" "));const scopesToMatch=((_a=keyToMatch.scope)===null||_a===void 0?void 0:_a.split(" "))||[];const hasAllScopes=cacheKey.scope&&scopesToMatch.reduce(((acc,current)=>acc&&scopeSet.has(current)),true);return cacheKey.prefix===CACHE_KEY_PREFIX&&cacheKey.clientId===keyToMatch.clientId&&cacheKey.audience===keyToMatch.audience&&hasAllScopes}))[0]}}const TRANSACTION_STORAGE_KEY_PREFIX="a0.spajs.txs";class TransactionManager{constructor(storage,clientId,cookieDomain){this.storage=storage;this.clientId=clientId;this.cookieDomain=cookieDomain;this.storageKey=`${TRANSACTION_STORAGE_KEY_PREFIX}.${this.clientId}`;}create(transaction){this.storage.save(this.storageKey,transaction,{daysUntilExpire:1,cookieDomain:this.cookieDomain});}get(){return this.storage.get(this.storageKey)}remove(){this.storage.remove(this.storageKey,{cookieDomain:this.cookieDomain});}}const isNumber=n=>typeof n==="number";const idTokendecoded=["iss","aud","exp","nbf","iat","jti","azp","nonce","auth_time","at_hash","c_hash","acr","amr","sub_jwk","cnf","sip_from_tag","sip_date","sip_callid","sip_cseq_num","sip_via_branch","orig","dest","mky","events","toe","txn","rph","sid","vot","vtm"];const decode=token=>{const parts=token.split(".");const[header,payload,signature]=parts;if(parts.length!==3||!header||!payload||!signature){throw new Error("ID token could not be decoded")}const payloadJSON=JSON.parse(urlDecodeB64(payload));const claims={__raw:token};const user={};Object.keys(payloadJSON).forEach((k=>{claims[k]=payloadJSON[k];if(!idTokendecoded.includes(k)){user[k]=payloadJSON[k];}}));return {encoded:{header:header,payload:payload,signature:signature},header:JSON.parse(urlDecodeB64(header)),claims:claims,user:user.user}};const verify=options=>{if(!options.id_token){throw new Error("ID token is required but missing")}const decoded=decode(options.id_token);if(!decoded.claims.iss){throw new Error("Issuer (iss) claim must be a string present in the ID token")}if(decoded.claims.iss!==options.iss){throw new Error(`Issuer (iss) claim mismatch in the ID token; expected "${options.iss}", found "${decoded.claims.iss}"`)}if(decoded.header.alg!=="RS256"){throw new Error(`Signature algorithm of "${decoded.header.alg}" is not supported. Expected the ID token to be signed with "RS256".`)}if(!decoded.claims.aud||!(typeof decoded.claims.aud==="string"||Array.isArray(decoded.claims.aud))){throw new Error("Audience (aud) claim must be a string or array of strings present in the ID token")}if(Array.isArray(decoded.claims.aud)){if(!decoded.claims.aud.includes(options.aud)){throw new Error(`Audience (aud) claim mismatch in the ID token; expected "${options.aud}" but was not one of "${decoded.claims.aud.join(", ")}"`)}if(decoded.claims.aud.length>1){if(!decoded.claims.azp){throw new Error("Authorized Party (azp) claim must be a string present in the ID token when Audience (aud) claim has multiple values")}if(decoded.claims.azp!==options.aud){throw new Error(`Authorized Party (azp) claim mismatch in the ID token; expected "${options.aud}", found "${decoded.claims.azp}"`)}}}else if(decoded.claims.aud!==options.aud){throw new Error(`Audience (aud) claim mismatch in the ID token; expected "${options.aud}" but found "${decoded.claims.aud}"`)}if(options.nonce){if(!decoded.claims.nonce){throw new Error("Nonce (nonce) claim must be a string present in the ID token")}if(decoded.claims.nonce!==options.nonce){throw new Error(`Nonce (nonce) claim mismatch in the ID token; expected "${options.nonce}", found "${decoded.claims.nonce}"`)}}if(options.max_age&&!isNumber(decoded.claims.auth_time)){throw new Error("Authentication Time (auth_time) claim must be a number present in the ID token when Max Age (max_age) is specified")}if(decoded.claims.exp==null||!isNumber(decoded.claims.exp)){throw new Error("Expiration Time (exp) claim must be a number present in the ID token")}if(!isNumber(decoded.claims.iat)){throw new Error("Issued At (iat) claim must be a number present in the ID token")}const leeway=options.leeway||60;const now=new Date(options.now||Date.now());const expDate=new Date(0);expDate.setUTCSeconds(decoded.claims.exp+leeway);if(now>expDate){throw new Error(`Expiration Time (exp) claim error in the ID token; current time (${now}) is after expiration time (${expDate})`)}if(decoded.claims.nbf!=null&&isNumber(decoded.claims.nbf)){const nbfDate=new Date(0);nbfDate.setUTCSeconds(decoded.claims.nbf-leeway);if(now<nbfDate){throw new Error(`Not Before time (nbf) claim in the ID token indicates that this token can't be used just yet. Current time (${now}) is before ${nbfDate}`)}}if(decoded.claims.auth_time!=null&&isNumber(decoded.claims.auth_time)){const authTimeDate=new Date(0);authTimeDate.setUTCSeconds(parseInt(decoded.claims.auth_time)+options.max_age+leeway);if(now>authTimeDate){throw new Error(`Authentication Time (auth_time) claim in the ID token indicates that too much time has passed since the last end-user authentication. Current time (${now}) is after last auth at ${authTimeDate}`)}}if(options.organization){const org=options.organization.trim();if(org.startsWith("org_")){const orgId=org;if(!decoded.claims.org_id){throw new Error("Organization ID (org_id) claim must be a string present in the ID token")}else if(orgId!==decoded.claims.org_id){throw new Error(`Organization ID (org_id) claim mismatch in the ID token; expected "${orgId}", found "${decoded.claims.org_id}"`)}}else {const orgName=org.toLowerCase();if(!decoded.claims.org_name){throw new Error("Organization Name (org_name) claim must be a string present in the ID token")}else if(orgName!==decoded.claims.org_name){throw new Error(`Organization Name (org_name) claim mismatch in the ID token; expected "${orgName}", found "${decoded.claims.org_name}"`)}}}return decoded};var esCookie=createCommonjsModule((function(module,exports){var __assign=commonjsGlobal&&commonjsGlobal.__assign||function(){__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++){s=arguments[i];for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p))t[p]=s[p];}return t};return __assign.apply(this,arguments)};exports.__esModule=true;function stringifyAttribute(name,value){if(!value){return ""}var stringified="; "+name;if(value===true){return stringified}return stringified+"="+value}function stringifyAttributes(attributes){if(typeof attributes.expires==="number"){var expires=new Date;expires.setMilliseconds(expires.getMilliseconds()+attributes.expires*864e5);attributes.expires=expires;}return stringifyAttribute("Expires",attributes.expires?attributes.expires.toUTCString():"")+stringifyAttribute("Domain",attributes.domain)+stringifyAttribute("Path",attributes.path)+stringifyAttribute("Secure",attributes.secure)+stringifyAttribute("SameSite",attributes.sameSite)}function encode(name,value,attributes){return encodeURIComponent(name).replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent).replace(/\(/g,"%28").replace(/\)/g,"%29")+"="+encodeURIComponent(value).replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent)+stringifyAttributes(attributes)}exports.encode=encode;function parse(cookieString){var result={};var cookies=cookieString?cookieString.split("; "):[];var rdecode=/(%[\dA-F]{2})+/gi;for(var i=0;i<cookies.length;i++){var parts=cookies[i].split("=");var cookie=parts.slice(1).join("=");if(cookie.charAt(0)==='"'){cookie=cookie.slice(1,-1);}try{var name_1=parts[0].replace(rdecode,decodeURIComponent);result[name_1]=cookie.replace(rdecode,decodeURIComponent);}catch(e){}}return result}exports.parse=parse;function getAll(){return parse(document.cookie)}exports.getAll=getAll;function get(name){return getAll()[name]}exports.get=get;function set(name,value,attributes){document.cookie=encode(name,value,__assign({path:"/"},attributes));}exports.set=set;function remove(name,attributes){set(name,"",__assign(__assign({},attributes),{expires:-1}));}exports.remove=remove;}));unwrapExports(esCookie);esCookie.encode;esCookie.parse;esCookie.getAll;var esCookie_4=esCookie.get;var esCookie_5=esCookie.set;var esCookie_6=esCookie.remove;const CookieStorage={get(key){const value=esCookie_4(key);if(typeof value==="undefined"){return}return JSON.parse(value)},save(key,value,options){let cookieAttributes={};if("https:"===window.location.protocol){cookieAttributes={secure:true,sameSite:"none"};}if(options===null||options===void 0?void 0:options.daysUntilExpire){cookieAttributes.expires=options.daysUntilExpire;}if(options===null||options===void 0?void 0:options.cookieDomain){cookieAttributes.domain=options.cookieDomain;}esCookie_5(key,JSON.stringify(value),cookieAttributes);},remove(key,options){let cookieAttributes={};if(options===null||options===void 0?void 0:options.cookieDomain){cookieAttributes.domain=options.cookieDomain;}esCookie_6(key,cookieAttributes);}};const LEGACY_PREFIX="_legacy_";const CookieStorageWithLegacySameSite={get(key){const value=CookieStorage.get(key);if(value){return value}return CookieStorage.get(`${LEGACY_PREFIX}${key}`)},save(key,value,options){let cookieAttributes={};if("https:"===window.location.protocol){cookieAttributes={secure:true};}if(options===null||options===void 0?void 0:options.daysUntilExpire){cookieAttributes.expires=options.daysUntilExpire;}if(options===null||options===void 0?void 0:options.cookieDomain){cookieAttributes.domain=options.cookieDomain;}esCookie_5(`${LEGACY_PREFIX}${key}`,JSON.stringify(value),cookieAttributes);CookieStorage.save(key,value,options);},remove(key,options){let cookieAttributes={};if(options===null||options===void 0?void 0:options.cookieDomain){cookieAttributes.domain=options.cookieDomain;}esCookie_6(key,cookieAttributes);CookieStorage.remove(key,options);CookieStorage.remove(`${LEGACY_PREFIX}${key}`,options);}};const SessionStorage={get(key){if(typeof sessionStorage==="undefined"){return}const value=sessionStorage.getItem(key);if(value==null){return}return JSON.parse(value)},save(key,value){sessionStorage.setItem(key,JSON.stringify(value));},remove(key){sessionStorage.removeItem(key);}};function decodeBase64(base64,enableUnicode){var binaryString=atob(base64);if(enableUnicode){var binaryView=new Uint8Array(binaryString.length);for(var i=0,n=binaryString.length;i<n;++i){binaryView[i]=binaryString.charCodeAt(i);}return String.fromCharCode.apply(null,new Uint16Array(binaryView.buffer))}return binaryString}function createURL(base64,sourcemapArg,enableUnicodeArg){var sourcemap=sourcemapArg===undefined?null:sourcemapArg;var enableUnicode=enableUnicodeArg===undefined?false:enableUnicodeArg;var source=decodeBase64(base64,enableUnicode);var start=source.indexOf("\n",10)+1;var body=source.substring(start)+(sourcemap?"//# sourceMappingURL="+sourcemap:"");var blob=new Blob([body],{type:"application/javascript"});return URL.createObjectURL(blob)}function createBase64WorkerFactory(base64,sourcemapArg,enableUnicodeArg){var url;return function WorkerFactory(options){url=url||createURL(base64,sourcemapArg,enableUnicodeArg);return new Worker(url,options)}}var WorkerFactory=createBase64WorkerFactory("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24oKXsidXNlIHN0cmljdCI7Y2xhc3MgR2VuZXJpY0Vycm9yIGV4dGVuZHMgRXJyb3J7Y29uc3RydWN0b3IoZXJyb3IsZXJyb3JfZGVzY3JpcHRpb24pe3N1cGVyKGVycm9yX2Rlc2NyaXB0aW9uKTt0aGlzLmVycm9yPWVycm9yO3RoaXMuZXJyb3JfZGVzY3JpcHRpb249ZXJyb3JfZGVzY3JpcHRpb247T2JqZWN0LnNldFByb3RvdHlwZU9mKHRoaXMsR2VuZXJpY0Vycm9yLnByb3RvdHlwZSl9c3RhdGljIGZyb21QYXlsb2FkKHtlcnJvcjplcnJvcixlcnJvcl9kZXNjcmlwdGlvbjplcnJvcl9kZXNjcmlwdGlvbn0pe3JldHVybiBuZXcgR2VuZXJpY0Vycm9yKGVycm9yLGVycm9yX2Rlc2NyaXB0aW9uKX19Y2xhc3MgTWlzc2luZ1JlZnJlc2hUb2tlbkVycm9yIGV4dGVuZHMgR2VuZXJpY0Vycm9ye2NvbnN0cnVjdG9yKGF1ZGllbmNlLHNjb3BlKXtzdXBlcigibWlzc2luZ19yZWZyZXNoX3Rva2VuIixgTWlzc2luZyBSZWZyZXNoIFRva2VuIChhdWRpZW5jZTogJyR7dmFsdWVPckVtcHR5U3RyaW5nKGF1ZGllbmNlLFsiZGVmYXVsdCJdKX0nLCBzY29wZTogJyR7dmFsdWVPckVtcHR5U3RyaW5nKHNjb3BlKX0nKWApO3RoaXMuYXVkaWVuY2U9YXVkaWVuY2U7dGhpcy5zY29wZT1zY29wZTtPYmplY3Quc2V0UHJvdG90eXBlT2YodGhpcyxNaXNzaW5nUmVmcmVzaFRva2VuRXJyb3IucHJvdG90eXBlKX19ZnVuY3Rpb24gdmFsdWVPckVtcHR5U3RyaW5nKHZhbHVlLGV4Y2x1ZGU9W10pe3JldHVybiB2YWx1ZSYmIWV4Y2x1ZGUuaW5jbHVkZXModmFsdWUpP3ZhbHVlOiIifWZ1bmN0aW9uIF9fcmVzdChzLGUpe3ZhciB0PXt9O2Zvcih2YXIgcCBpbiBzKWlmKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzLHApJiZlLmluZGV4T2YocCk8MCl0W3BdPXNbcF07aWYocyE9bnVsbCYmdHlwZW9mIE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHM9PT0iZnVuY3Rpb24iKWZvcih2YXIgaT0wLHA9T2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhzKTtpPHAubGVuZ3RoO2krKyl7aWYoZS5pbmRleE9mKHBbaV0pPDAmJk9iamVjdC5wcm90b3R5cGUucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChzLHBbaV0pKXRbcFtpXV09c1twW2ldXX1yZXR1cm4gdH10eXBlb2YgU3VwcHJlc3NlZEVycm9yPT09ImZ1bmN0aW9uIj9TdXBwcmVzc2VkRXJyb3I6ZnVuY3Rpb24oZXJyb3Isc3VwcHJlc3NlZCxtZXNzYWdlKXt2YXIgZT1uZXcgRXJyb3IobWVzc2FnZSk7cmV0dXJuIGUubmFtZT0iU3VwcHJlc3NlZEVycm9yIixlLmVycm9yPWVycm9yLGUuc3VwcHJlc3NlZD1zdXBwcmVzc2VkLGV9O2NvbnN0IHN0cmlwVW5kZWZpbmVkPXBhcmFtcz0+T2JqZWN0LmtleXMocGFyYW1zKS5maWx0ZXIoKGs9PnR5cGVvZiBwYXJhbXNba10hPT0idW5kZWZpbmVkIikpLnJlZHVjZSgoKGFjYyxrZXkpPT5PYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sYWNjKSx7W2tleV06cGFyYW1zW2tleV19KSkse30pO2NvbnN0IGNyZWF0ZVF1ZXJ5UGFyYW1zPV9hPT57dmFye2NsaWVudElkOmNsaWVudF9pZH09X2EscGFyYW1zPV9fcmVzdChfYSxbImNsaWVudElkIl0pO3JldHVybiBuZXcgVVJMU2VhcmNoUGFyYW1zKHN0cmlwVW5kZWZpbmVkKE9iamVjdC5hc3NpZ24oe2NsaWVudF9pZDpjbGllbnRfaWR9LHBhcmFtcykpKS50b1N0cmluZygpfTtsZXQgcmVmcmVzaFRva2Vucz17fTtjb25zdCBjYWNoZUtleT0oYXVkaWVuY2Usc2NvcGUpPT5gJHthdWRpZW5jZX18JHtzY29wZX1gO2NvbnN0IGdldFJlZnJlc2hUb2tlbj0oYXVkaWVuY2Usc2NvcGUpPT5yZWZyZXNoVG9rZW5zW2NhY2hlS2V5KGF1ZGllbmNlLHNjb3BlKV07Y29uc3Qgc2V0UmVmcmVzaFRva2VuPShyZWZyZXNoVG9rZW4sYXVkaWVuY2Usc2NvcGUpPT5yZWZyZXNoVG9rZW5zW2NhY2hlS2V5KGF1ZGllbmNlLHNjb3BlKV09cmVmcmVzaFRva2VuO2NvbnN0IGRlbGV0ZVJlZnJlc2hUb2tlbj0oYXVkaWVuY2Usc2NvcGUpPT5kZWxldGUgcmVmcmVzaFRva2Vuc1tjYWNoZUtleShhdWRpZW5jZSxzY29wZSldO2NvbnN0IHdhaXQ9dGltZT0+bmV3IFByb21pc2UoKHJlc29sdmU9PnNldFRpbWVvdXQocmVzb2x2ZSx0aW1lKSkpO2NvbnN0IGZvcm1EYXRhVG9PYmplY3Q9Zm9ybURhdGE9Pntjb25zdCBxdWVyeVBhcmFtcz1uZXcgVVJMU2VhcmNoUGFyYW1zKGZvcm1EYXRhKTtjb25zdCBwYXJzZWRRdWVyeT17fTtxdWVyeVBhcmFtcy5mb3JFYWNoKCgodmFsLGtleSk9PntwYXJzZWRRdWVyeVtrZXldPXZhbH0pKTtyZXR1cm4gcGFyc2VkUXVlcnl9O2NvbnN0IG1lc3NhZ2VIYW5kbGVyPWFzeW5jKHtkYXRhOnt0aW1lb3V0OnRpbWVvdXQsYXV0aDphdXRoLGZldGNoVXJsOmZldGNoVXJsLGZldGNoT3B0aW9uczpmZXRjaE9wdGlvbnMsdXNlRm9ybURhdGE6dXNlRm9ybURhdGF9LHBvcnRzOltwb3J0XX0pPT57bGV0IGpzb247Y29uc3R7YXVkaWVuY2U6YXVkaWVuY2Usc2NvcGU6c2NvcGV9PWF1dGh8fHt9O3RyeXtjb25zdCBib2R5PXVzZUZvcm1EYXRhP2Zvcm1EYXRhVG9PYmplY3QoZmV0Y2hPcHRpb25zLmJvZHkpOkpTT04ucGFyc2UoZmV0Y2hPcHRpb25zLmJvZHkpO2lmKCFib2R5LnJlZnJlc2hfdG9rZW4mJmJvZHkuZ3JhbnRfdHlwZT09PSJyZWZyZXNoX3Rva2VuIil7Y29uc3QgcmVmcmVzaFRva2VuPWdldFJlZnJlc2hUb2tlbihhdWRpZW5jZSxzY29wZSk7aWYoIXJlZnJlc2hUb2tlbil7dGhyb3cgbmV3IE1pc3NpbmdSZWZyZXNoVG9rZW5FcnJvcihhdWRpZW5jZSxzY29wZSl9ZmV0Y2hPcHRpb25zLmJvZHk9dXNlRm9ybURhdGE/Y3JlYXRlUXVlcnlQYXJhbXMoT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LGJvZHkpLHtyZWZyZXNoX3Rva2VuOnJlZnJlc2hUb2tlbn0pKTpKU09OLnN0cmluZ2lmeShPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sYm9keSkse3JlZnJlc2hfdG9rZW46cmVmcmVzaFRva2VufSkpfWxldCBhYm9ydENvbnRyb2xsZXI7aWYodHlwZW9mIEFib3J0Q29udHJvbGxlcj09PSJmdW5jdGlvbiIpe2Fib3J0Q29udHJvbGxlcj1uZXcgQWJvcnRDb250cm9sbGVyO2ZldGNoT3B0aW9ucy5zaWduYWw9YWJvcnRDb250cm9sbGVyLnNpZ25hbH1sZXQgcmVzcG9uc2U7dHJ5e3Jlc3BvbnNlPWF3YWl0IFByb21pc2UucmFjZShbd2FpdCh0aW1lb3V0KSxmZXRjaChmZXRjaFVybCxPYmplY3QuYXNzaWduKHt9LGZldGNoT3B0aW9ucykpXSl9Y2F0Y2goZXJyb3Ipe3BvcnQucG9zdE1lc3NhZ2Uoe2Vycm9yOmVycm9yLm1lc3NhZ2V9KTtyZXR1cm59aWYoIXJlc3BvbnNlKXtpZihhYm9ydENvbnRyb2xsZXIpYWJvcnRDb250cm9sbGVyLmFib3J0KCk7cG9ydC5wb3N0TWVzc2FnZSh7ZXJyb3I6IlRpbWVvdXQgd2hlbiBleGVjdXRpbmcgJ2ZldGNoJyJ9KTtyZXR1cm59anNvbj1hd2FpdCByZXNwb25zZS5qc29uKCk7aWYoanNvbi5yZWZyZXNoX3Rva2VuKXtzZXRSZWZyZXNoVG9rZW4oanNvbi5yZWZyZXNoX3Rva2VuLGF1ZGllbmNlLHNjb3BlKTtkZWxldGUganNvbi5yZWZyZXNoX3Rva2VufWVsc2V7ZGVsZXRlUmVmcmVzaFRva2VuKGF1ZGllbmNlLHNjb3BlKX1wb3J0LnBvc3RNZXNzYWdlKHtvazpyZXNwb25zZS5vayxqc29uOmpzb259KX1jYXRjaChlcnJvcil7cG9ydC5wb3N0TWVzc2FnZSh7b2s6ZmFsc2UsanNvbjp7ZXJyb3I6ZXJyb3IuZXJyb3IsZXJyb3JfZGVzY3JpcHRpb246ZXJyb3IubWVzc2FnZX19KX19O3thZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIixtZXNzYWdlSGFuZGxlcil9fSkoKTsKCg==",null,false);const singlePromiseMap={};const singlePromise=(cb,key)=>{let promise=singlePromiseMap[key];if(!promise){promise=cb().finally((()=>{delete singlePromiseMap[key];promise=null;}));singlePromiseMap[key]=promise;}return promise};const retryPromise=async(cb,maxNumberOfRetries=3)=>{for(let i=0;i<maxNumberOfRetries;i++){if(await cb()){return true}}return false};class CacheKeyManifest{constructor(cache,clientId){this.cache=cache;this.clientId=clientId;this.manifestKey=this.createManifestKeyFrom(this.clientId);}async add(key){var _a;const keys=new Set(((_a=await this.cache.get(this.manifestKey))===null||_a===void 0?void 0:_a.keys)||[]);keys.add(key);await this.cache.set(this.manifestKey,{keys:[...keys]});}async remove(key){const entry=await this.cache.get(this.manifestKey);if(entry){const keys=new Set(entry.keys);keys.delete(key);if(keys.size>0){return await this.cache.set(this.manifestKey,{keys:[...keys]})}return await this.cache.remove(this.manifestKey)}}get(){return this.cache.get(this.manifestKey)}clear(){return this.cache.remove(this.manifestKey)}createManifestKeyFrom(clientId){return `${CACHE_KEY_PREFIX}::${clientId}`}}const GET_TOKEN_SILENTLY_LOCK_KEY="eartho.lock.getTokenSilently";const buildOrganizationHintCookieName=clientId=>`eartho.${clientId}.organization_hint`;const OLD_IS_AUTHENTICATED_COOKIE_NAME="eartho.is.authenticated";const buildisConnectedCookieName=clientId=>`eartho.${clientId}.is.authenticated`;const cacheLocationBuilders={memory:()=>(new InMemoryCache).enclosedCache,localstorage:()=>new LocalStorageCache};const cacheFactory=location=>cacheLocationBuilders[location];const getAuthorizeParams=(clientOptions,scope,authorizationParams,state,nonce,code_challenge,redirect_uri,response_mode,access_id)=>Object.assign(Object.assign(Object.assign({client_id:clientOptions.clientId},clientOptions.authorizationParams),authorizationParams),{scope:getUniqueScopes(scope,authorizationParams.scope),response_type:"code",response_mode:response_mode||"query",state:state,nonce:nonce,redirect_uri:redirect_uri||clientOptions.authorizationParams.redirect_uri,code_challenge:code_challenge,code_challenge_method:"S256",access_id:authorizationParams.access_id});const patchOpenUrlWithOnRedirect=options=>{const{openUrl:openUrl,onRedirect:onRedirect}=options,originalOptions=__rest(options,["openUrl","onRedirect"]);const result=Object.assign(Object.assign({},originalOptions),{openUrl:openUrl===false||openUrl?openUrl:onRedirect});return result};const lock=new Lock;class EarthoOne{constructor(options){var _a;this.userCache=(new InMemoryCache).enclosedCache;this.defaultOptions={authorizationParams:{scope:DEFAULT_SCOPE},useRefreshTokensFallback:false,useFormData:true};this._releaseLockOnPageHide=async()=>{await lock.releaseLock(GET_TOKEN_SILENTLY_LOCK_KEY);window.removeEventListener("pagehide",this._releaseLockOnPageHide);};const authDomain="api.eartho.io";options.domain="one.eartho.io";options.issuer="https://one.eartho.world/";options.authorizationParams=options.authorizationParams||{};options.authorizationParams.audience=((_a=options.authorizationParams)===null||_a===void 0?void 0:_a.audience)||options.clientId;options.cacheLocation=CACHE_LOCATION_LOCAL_STORAGE;options.useRefreshTokens=true;this.domainUrl=getDomain(options.domain);this.authDomainUrl=getDomain(authDomain);this.options=Object.assign(Object.assign(Object.assign({},this.defaultOptions),options),{authorizationParams:Object.assign(Object.assign({},this.defaultOptions.authorizationParams),options.authorizationParams)});typeof window!=="undefined"&&validateCrypto();if(options.cache&&options.cacheLocation){console.warn("Both `cache` and `cacheLocation` options have been specified in the EarthoOne configuration; ignoring `cacheLocation` and using `cache`.");}let cacheLocation;let cache;if(options.cache){cache=options.cache;}else {cacheLocation=options.cacheLocation||CACHE_LOCATION_MEMORY;if(!cacheFactory(cacheLocation)){throw new Error(`Invalid cache location "${cacheLocation}"`)}cache=cacheFactory(cacheLocation)();}this.httpTimeoutMs=options.httpTimeoutInSeconds?options.httpTimeoutInSeconds*1e3:DEFAULT_FETCH_TIMEOUT_MS;this.cookieStorage=options.legacySameSiteCookie===false?CookieStorage:CookieStorageWithLegacySameSite;this.orgHintCookieName=buildOrganizationHintCookieName(this.options.clientId);this.isConnectedCookieName=buildisConnectedCookieName(this.options.clientId);this.sessionCheckExpiryDays=options.sessionCheckExpiryDays||DEFAULT_SESSION_CHECK_EXPIRY_DAYS;const transactionStorage=options.useCookiesForTransactions?this.cookieStorage:SessionStorage;this.scope=getUniqueScopes("openid",this.options.authorizationParams.scope,this.options.useRefreshTokens?"offline_access":"");this.transactionManager=new TransactionManager(transactionStorage,this.options.clientId,this.options.cookieDomain);this.nowProvider=this.options.nowProvider||DEFAULT_NOW_PROVIDER;this.cacheManager=new CacheManager(cache,!cache.allKeys?new CacheKeyManifest(cache,this.options.clientId):undefined,this.nowProvider);this.domainUrl=getDomain(this.options.domain);this.tokenIssuer=getTokenIssuer(this.options.issuer,this.domainUrl);if(typeof window!=="undefined"&&window.Worker&&this.options.useRefreshTokens&&cacheLocation===CACHE_LOCATION_MEMORY){if(this.options.workerUrl){this.worker=new Worker(this.options.workerUrl);}else {this.worker=new WorkerFactory;}}}_url(path,domain){const earthoOneClient=encodeURIComponent(btoa(JSON.stringify(this.options.earthoOneClient||DEFAULT_EARTHO_CLIENT)));return `${domain||this.domainUrl}${path}&earthoOneClient=${earthoOneClient}`}_authorizeUrl(authorizeOptions){return this._url(`/connect?${createQueryParams(authorizeOptions)}`)}async _verifyIdToken(id_token,nonce,organization){const now=await this.nowProvider();return verify({iss:this.tokenIssuer,aud:this.options.clientId,id_token:id_token,nonce:nonce,organization:organization,leeway:this.options.leeway,max_age:parseNumber(this.options.authorizationParams.max_age),now:now})}_processOrgHint(organization){if(organization){this.cookieStorage.save(this.orgHintCookieName,organization,{daysUntilExpire:this.sessionCheckExpiryDays,cookieDomain:this.options.cookieDomain});}else {this.cookieStorage.remove(this.orgHintCookieName,{cookieDomain:this.options.cookieDomain});}}async _prepareAuthorizeUrl(authorizationParams,authorizeOptions,fallbackRedirectUri){const state=encode(createRandomString());const nonce=encode(createRandomString());const code_verifier=createRandomString();const code_challengeBuffer=await sha256(code_verifier);const code_challenge=bufferToBase64UrlEncoded(code_challengeBuffer);const params=getAuthorizeParams(this.options,this.scope,authorizationParams,state,nonce,code_challenge,authorizationParams.redirect_uri||this.options.authorizationParams.redirect_uri||fallbackRedirectUri,authorizeOptions===null||authorizeOptions===void 0?void 0:authorizeOptions.response_mode,authorizationParams.access_id||"");const url=this._authorizeUrl(params);return {nonce:nonce,code_verifier:code_verifier,scope:params.scope,audience:params.audience||"default",redirect_uri:params.redirect_uri,state:state,url:url,access_id:params.access_id||""}}async connectWithPopup(options,config){var _a;options=options||{};config=config||{};if(!config.popup){config.popup=openPopup("");if(!config.popup){throw new Error("Unable to open a popup for connectWithPopup - window.open returned `null`")}}const authorizationParams=options.authorizationParams||{};authorizationParams.access_id=options.accessId;if(options.enabledAuthProviders)authorizationParams.enabled_providers=options.enabledAuthProviders;const params=await this._prepareAuthorizeUrl(authorizationParams,{response_mode:"web_message"},window.location.origin);config.popup.location.href=params.url;const codeResult=await runPopup(Object.assign(Object.assign({},config),{timeoutInSeconds:config.timeoutInSeconds||this.options.authorizeTimeoutInSeconds||DEFAULT_AUTHORIZE_TIMEOUT_IN_SECONDS}));if(params.state!==codeResult.state){throw new GenericError("state_mismatch","Invalid state")}const organization=((_a=options.authorizationParams)===null||_a===void 0?void 0:_a.organization)||this.options.authorizationParams.organization;await this._requestToken({audience:params.audience,scope:params.scope,code_verifier:params.code_verifier,grant_type:"authorization_code",code:codeResult.code,redirect_uri:params.redirect_uri},{nonceIn:params.nonce,organization:organization});}async getUser(){var _a;const cache=await this._getIdTokenFromCache();return (_a=cache===null||cache===void 0?void 0:cache.decodedToken)===null||_a===void 0?void 0:_a.user}async getIdToken(){var _a;const cache=await this._getIdTokenFromCache();return (_a=cache===null||cache===void 0?void 0:cache.decodedToken)===null||_a===void 0?void 0:_a.claims.__raw}async connectWithRedirect(options){var _a;const _b=patchOpenUrlWithOnRedirect(options),{accessId:accessId,openUrl:openUrl,fragment:fragment,appState:appState}=_b,urlOptions=__rest(_b,["accessId","openUrl","fragment","appState"]);const organization=((_a=urlOptions.authorizationParams)===null||_a===void 0?void 0:_a.organization)||this.options.authorizationParams.organization;const authorizationParams=urlOptions.authorizationParams||{};authorizationParams.access_id=options.accessId;authorizationParams.redirect_uri=authorizationParams.redirect_uri||window.location.origin;if(options.enabledAuthProviders)authorizationParams.enabled_providers=options.enabledAuthProviders;const _c=await this._prepareAuthorizeUrl(authorizationParams),{url:url}=_c,transaction=__rest(_c,["url"]);this.transactionManager.create(Object.assign(Object.assign(Object.assign({},transaction),{appState:appState}),organization&&{organization:organization}));const urlWithFragment=fragment?`${url}#${fragment}`:url;if(openUrl){await openUrl(urlWithFragment);}else {window.location.assign(urlWithFragment);}}async handleRedirectCallback(url=window.location.href){const queryStringFragments=url.split("?").slice(1);if(queryStringFragments.length===0){throw new Error("There are no query params available for parsing.")}const{state:state,code:code,error:error,error_description:error_description}=parseAuthenticationResult(queryStringFragments.join(""));const transaction=this.transactionManager.get();if(!transaction){throw new GenericError("missing_transaction","Invalid state")}this.transactionManager.remove();if(error){throw new AuthenticationError(error,error_description||error,state,transaction.appState)}if(!transaction.code_verifier||transaction.state&&transaction.state!==state){throw new GenericError("state_mismatch","Invalid state")}const organization=transaction.organization;const nonceIn=transaction.nonce;const redirect_uri=transaction.redirect_uri;await this._requestToken(Object.assign({audience:transaction.audience,scope:transaction.scope,code_verifier:transaction.code_verifier,grant_type:"authorization_code",code:code},redirect_uri?{redirect_uri:redirect_uri}:{}),{nonceIn:nonceIn,organization:organization});return {appState:transaction.appState}}async checkSession(options){if(!this.cookieStorage.get(this.isConnectedCookieName)){if(!this.cookieStorage.get(OLD_IS_AUTHENTICATED_COOKIE_NAME)){return}else {this.cookieStorage.save(this.isConnectedCookieName,true,{daysUntilExpire:this.sessionCheckExpiryDays,cookieDomain:this.options.cookieDomain});this.cookieStorage.remove(OLD_IS_AUTHENTICATED_COOKIE_NAME);}}try{await this.getTokenSilently(options);}catch(_){}}async getTokenSilently(options={}){var _a;const localOptions=Object.assign(Object.assign({cacheMode:"on"},options),{authorizationParams:Object.assign(Object.assign(Object.assign({},this.options.authorizationParams),options.authorizationParams),{scope:getUniqueScopes(this.scope,(_a=options.authorizationParams)===null||_a===void 0?void 0:_a.scope)})});const result=await singlePromise((()=>this._getTokenSilently(localOptions)),`${this.options.clientId}::${localOptions.authorizationParams.audience}::${localOptions.authorizationParams.scope}`);return options.detailedResponse?result:result===null||result===void 0?void 0:result.access_token}async _getTokenSilently(options){const{cacheMode:cacheMode}=options,getTokenOptions=__rest(options,["cacheMode"]);if(cacheMode!=="off"){const entry=await this._getEntryFromCache({scope:getTokenOptions.authorizationParams.scope,audience:getTokenOptions.authorizationParams.audience||"default",clientId:this.options.clientId});if(entry){return entry}}if(cacheMode==="cache-only"){return}if(await retryPromise((()=>lock.acquireLock(GET_TOKEN_SILENTLY_LOCK_KEY,5e3)),10)){try{window.addEventListener("pagehide",this._releaseLockOnPageHide);if(cacheMode!=="off"){const entry=await this._getEntryFromCache({scope:getTokenOptions.authorizationParams.scope,audience:getTokenOptions.authorizationParams.audience||"default",clientId:this.options.clientId});if(entry){return entry}}const authResult=this.options.useRefreshTokens?await this._getTokenUsingRefreshToken(getTokenOptions):await this._getTokenFromIFrame(getTokenOptions);const{id_token:id_token,access_token:access_token,oauthTokenScope:oauthTokenScope,expires_in:expires_in}=authResult;return Object.assign(Object.assign({id_token:id_token,access_token:access_token},oauthTokenScope?{scope:oauthTokenScope}:null),{expires_in:expires_in})}finally{await lock.releaseLock(GET_TOKEN_SILENTLY_LOCK_KEY);window.removeEventListener("pagehide",this._releaseLockOnPageHide);}}else {throw new TimeoutError}}async getTokenWithPopup(options,config={}){var _a;const localOptions=Object.assign(Object.assign({},options),{authorizationParams:Object.assign(Object.assign(Object.assign({},this.options.authorizationParams),options.authorizationParams),{scope:getUniqueScopes(this.scope,(_a=options.authorizationParams)===null||_a===void 0?void 0:_a.scope)})});config=Object.assign(Object.assign({},DEFAULT_POPUP_CONFIG_OPTIONS),config);await this.connectWithPopup(localOptions,config);const cache=await this.cacheManager.get(new CacheKey({scope:localOptions.authorizationParams.scope,audience:localOptions.authorizationParams.audience||"default",clientId:this.options.clientId}));return cache.access_token}async isConnected(){const user=await this.getUser();return !!user}_buildLogoutUrl(options){if(options.clientId!==null){options.clientId=options.clientId||this.options.clientId;}else {delete options.clientId;}const _a=options.logoutParams||{},{federated:federated}=_a,logoutOptions=__rest(_a,["federated"]);const federatedQuery=federated?`&federated`:"";const url=this._url(`/logout?${createQueryParams(Object.assign({clientId:options.clientId},logoutOptions))}`);return url+federatedQuery}async logout(options={}){const _a=patchOpenUrlWithOnRedirect(options),logoutOptions=__rest(_a,["openUrl"]);if(options.clientId===null){await this.cacheManager.clear();}else {await this.cacheManager.clear(options.clientId||this.options.clientId);}this.cookieStorage.remove(this.orgHintCookieName,{cookieDomain:this.options.cookieDomain});this.cookieStorage.remove(this.isConnectedCookieName,{cookieDomain:this.options.cookieDomain});this.userCache.remove(CACHE_KEY_ID_TOKEN_SUFFIX);this._buildLogoutUrl(logoutOptions);}async _getTokenFromIFrame(options){const params=Object.assign(Object.assign({},options.authorizationParams),{prompt:"none"});const orgHint=this.cookieStorage.get(this.orgHintCookieName);if(orgHint&&!params.organization){params.organization=orgHint;}const{url:url,state:stateIn,nonce:nonceIn,code_verifier:code_verifier,redirect_uri:redirect_uri,scope:scope,audience:audience}=await this._prepareAuthorizeUrl(params,{response_mode:"web_message"},window.location.origin);try{if(window.crossOriginIsolated){throw new GenericError("login_required","The application is running in a Cross-Origin Isolated context, silently retrieving a token without refresh token is not possible.")}const authorizeTimeout=options.timeoutInSeconds||this.options.authorizeTimeoutInSeconds;const codeResult=await runIframe(url,this.domainUrl,authorizeTimeout);if(stateIn!==codeResult.state){throw new GenericError("state_mismatch","Invalid state")}const tokenResult=await this._requestToken(Object.assign(Object.assign({},options.authorizationParams),{code_verifier:code_verifier,code:codeResult.code,grant_type:"authorization_code",redirect_uri:redirect_uri,timeout:options.authorizationParams.timeout||this.httpTimeoutMs}),{nonceIn:nonceIn,organization:params.organization});return Object.assign(Object.assign({},tokenResult),{scope:scope,oauthTokenScope:tokenResult.scope,audience:audience})}catch(e){if(e.error==="login_required"){this.logout({openUrl:false});}throw e}}async _getTokenUsingRefreshToken(options){const cache=await this.cacheManager.get(new CacheKey({scope:options.authorizationParams.scope,audience:options.authorizationParams.audience||"default",clientId:this.options.clientId}));if((!cache||!cache.refresh_token)&&!this.worker){if(this.options.useRefreshTokensFallback){return await this._getTokenFromIFrame(options)}throw new MissingRefreshTokenError(options.authorizationParams.audience||"default",options.authorizationParams.scope)}const redirect_uri=options.authorizationParams.redirect_uri||this.options.authorizationParams.redirect_uri||window.location.origin;const timeout=typeof options.timeoutInSeconds==="number"?options.timeoutInSeconds*1e3:null;try{const tokenResult=await this._requestToken(Object.assign(Object.assign(Object.assign({},options.authorizationParams),{grant_type:"refresh_token",refresh_token:cache&&cache.refresh_token,redirect_uri:redirect_uri}),timeout&&{timeout:timeout}));return Object.assign(Object.assign({},tokenResult),{scope:options.authorizationParams.scope,oauthTokenScope:tokenResult.scope,audience:options.authorizationParams.audience||"default"})}catch(e){if((e.message.indexOf(MISSING_REFRESH_TOKEN_ERROR_MESSAGE)>-1||e.message&&e.message.indexOf(INVALID_REFRESH_TOKEN_ERROR_MESSAGE)>-1)&&this.options.useRefreshTokensFallback){return await this._getTokenFromIFrame(options)}throw e}}async _saveEntryInCache(entry){const{id_token:id_token,decodedToken:decodedToken}=entry,entryWithoutIdToken=__rest(entry,["id_token","decodedToken"]);this.userCache.set(CACHE_KEY_ID_TOKEN_SUFFIX,{id_token:id_token,decodedToken:decodedToken});await this.cacheManager.setIdToken(this.options.clientId,entry.id_token,entry.decodedToken);await this.cacheManager.set(entryWithoutIdToken);}async _getIdTokenFromCache(){const audience=this.options.authorizationParams.audience||"default";const cache=await this.cacheManager.getIdToken(new CacheKey({clientId:this.options.clientId,audience:audience,scope:this.scope}));const currentCache=this.userCache.get(CACHE_KEY_ID_TOKEN_SUFFIX);if(cache&&cache.id_token===(currentCache===null||currentCache===void 0?void 0:currentCache.id_token)){return currentCache}this.userCache.set(CACHE_KEY_ID_TOKEN_SUFFIX,cache);return cache}async _getEntryFromCache({scope:scope,audience:audience,clientId:clientId}){const entry=await this.cacheManager.get(new CacheKey({scope:scope,audience:audience,clientId:clientId}),60);if(entry&&entry.access_token){const{access_token:access_token,oauthTokenScope:oauthTokenScope,expires_in:expires_in}=entry;const cache=await this._getIdTokenFromCache();return cache&&Object.assign(Object.assign({id_token:cache.id_token,access_token:access_token},oauthTokenScope?{scope:oauthTokenScope}:null),{expires_in:expires_in})}}async _requestToken(options,additionalParameters){const{nonceIn:nonceIn,organization:organization}=additionalParameters||{};const authResult=await oauthToken(Object.assign({baseUrl:this.authDomainUrl,client_id:this.options.clientId,earthoOneClient:this.options.earthoOneClient,useFormData:this.options.useFormData,timeout:this.httpTimeoutMs},options),this.worker);const decodedToken=await this._verifyIdToken(authResult.id_token,nonceIn,organization);await this._saveEntryInCache(Object.assign(Object.assign(Object.assign(Object.assign({},authResult),{decodedToken:decodedToken,scope:options.scope,audience:options.audience||"default"}),authResult.scope?{oauthTokenScope:authResult.scope}:null),{client_id:this.options.clientId}));this.cookieStorage.save(this.isConnectedCookieName,true,{daysUntilExpire:this.sessionCheckExpiryDays,cookieDomain:this.options.cookieDomain});this._processOrgHint(organization||decodedToken.claims.org_id);return Object.assign(Object.assign({},authResult),{decodedToken:decodedToken})}}class User{}

    /**
     * The initial auth state.
     */
    var initialAuthState = {
        isConnected: false,
        isLoading: true,
    };

    /**
     * @ignore
     */
    var stub = function () {
        throw new Error('You forgot to wrap your component in <EarthoOneProvider>.');
    };
    /**
     * @ignore
     */
    var initialContext = __assign(__assign({}, initialAuthState), { buildAuthorizeUrl: stub, buildLogoutUrl: stub, getUser: stub, getIdToken: stub, connectWithRedirect: stub, connectWithPopup: stub, logout: stub, handleRedirectCallback: stub });
    /**
     * The Eartho Context
     */
    var EarthoOneContext = React.createContext(initialContext);

    /**
     * An OAuth2 error will come from the authorization server and will have at least an `error` property which will
     * be the error code. And possibly an `error_description` property
     *
     * See: https://openid.net/specs/openid-connect-core-1_0.html#rfc.section.3.1.2.6
     */
    var OAuthError = /** @class */ (function (_super) {
        __extends(OAuthError, _super);
        function OAuthError(error, error_description) {
            var _this = _super.call(this, error_description || error) || this;
            _this.error = error;
            _this.error_description = error_description;
            // https://github.com/Microsoft/TypeScript-wiki/blob/master/Breaking-Changes.md#extending-built-ins-like-error-array-and-map-may-no-longer-work
            Object.setPrototypeOf(_this, OAuthError.prototype);
            return _this;
        }
        return OAuthError;
    }(Error));

    var CODE_RE = /[?&]code=[^&]+/;
    var STATE_RE = /[?&]state=[^&]+/;
    var ERROR_RE = /[?&]error=[^&]+/;
    var hasAuthParams = function (searchParams) {
        if (searchParams === void 0) { searchParams = window.location.search; }
        return (CODE_RE.test(searchParams) || ERROR_RE.test(searchParams)) &&
            STATE_RE.test(searchParams);
    };
    var normalizeErrorFn = function (fallbackMessage) {
        return function (error) {
            if (error instanceof Error) {
                return error;
            }
            // try to check errors of the following form: {error: string; error_description?: string}
            if (error !== null &&
                typeof error === 'object' &&
                'error' in error &&
                typeof error.error === 'string') {
                if ('error_description' in error &&
                    typeof error.error_description === 'string') {
                    return new OAuthError(error.error, error.error_description);
                }
                return new OAuthError(error.error);
            }
            return new Error(fallbackMessage);
        };
    };
    var loginError = normalizeErrorFn('Login failed');
    var tokenError = normalizeErrorFn('Get access token failed');
    /**
     * @ignore
     * Helper function to map the v1 `redirectUri` option to the v2 `authorizationParams.redirect_uri`
     * and log a warning.
     */
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    var deprecateRedirectUri = function (options) {
        var _a;
        if (options === null || options === void 0 ? void 0 : options.redirectUri) {
            console.warn('Using `redirectUri` has been deprecated, please use `authorizationParams.redirect_uri` instead as `redirectUri` will be no longer supported in a future version');
            options.authorizationParams = options.authorizationParams || {};
            options.authorizationParams.redirect_uri = options.redirectUri;
            delete options.redirectUri;
        }
        if ((_a = options === null || options === void 0 ? void 0 : options.authorizationParams) === null || _a === void 0 ? void 0 : _a.redirectUri) {
            console.warn('Using `authorizationParams.redirectUri` has been deprecated, please use `authorizationParams.redirect_uri` instead as `authorizationParams.redirectUri` will be removed in a future version');
            options.authorizationParams.redirect_uri =
                options.authorizationParams.redirectUri;
            delete options.authorizationParams.redirectUri;
        }
    };

    /**
     * Handles how that state changes in the `useEarthoOne` hook.
     */
    var reducer = function (state, action) {
        switch (action.type) {
            case 'LOGIN_POPUP_STARTED':
                return __assign(__assign({}, state), { isLoading: true });
            case 'LOGIN_POPUP_COMPLETE':
            case 'INITIALISED':
                return __assign(__assign({}, state), { isConnected: !!action.user, user: action.user, isLoading: false, error: undefined });
            case 'HANDLE_REDIRECT_COMPLETE':
            case 'GET_ACCESS_TOKEN_COMPLETE':
                if (state.user === action.user) {
                    return state;
                }
                return __assign(__assign({}, state), { isConnected: !!action.user, user: action.user });
            case 'LOGOUT':
                return __assign(__assign({}, state), { isConnected: false, user: undefined });
            case 'ERROR':
                return __assign(__assign({}, state), { isLoading: false, error: action.error });
        }
    };

    /**
     * @ignore
     */
    var toEarthoOneOptions = function (opts) {
        deprecateRedirectUri(opts);
        return __assign(__assign({}, opts), { earthoOneClient: {
                name: 'one-client-react',
                version: '2.0.12',
            } });
    };
    /**
     * @ignore
     */
    var defaultOnRedirectCallback = function (appState) {
        window.history.replaceState({}, document.title, (appState === null || appState === void 0 ? void 0 : appState.returnTo) || window.location.pathname);
    };
    /**
     * ```jsx
     * <EarthoOneProvider
     *   domain={domain}
     *   clientId={clientId}
     *   authorizationParams={{ redirect_uri: window.location.origin }}>
     *   <MyApp />
     * </EarthoOneProvider>
     * ```
     *
     * Provides the EarthoOneContext to its child components.
     */
    var EarthoOneProvider = function (opts) {
        var children = opts.children, skipRedirectCallback = opts.skipRedirectCallback, _a = opts.onRedirectCallback, onRedirectCallback = _a === void 0 ? defaultOnRedirectCallback : _a, _b = opts.context, context = _b === void 0 ? EarthoOneContext : _b, clientOpts = __rest$1(opts, ["children", "skipRedirectCallback", "onRedirectCallback", "context"]);
        var client = React.useState(function () { return new EarthoOne(toEarthoOneOptions(clientOpts)); })[0];
        var _c = React.useReducer(reducer, initialAuthState), state = _c[0], dispatch = _c[1];
        var didInitialise = React.useRef(false);
        React.useEffect(function () {
            if (didInitialise.current) {
                return;
            }
            didInitialise.current = true;
            (function () { return __awaiter(void 0, void 0, void 0, function () {
                var user, appState, error_1;
                return __generator(this, function (_a) {
                    switch (_a.label) {
                        case 0:
                            _a.trys.push([0, 7, , 8]);
                            user = void 0;
                            if (!(hasAuthParams() && !skipRedirectCallback)) return [3 /*break*/, 3];
                            return [4 /*yield*/, client.handleRedirectCallback()];
                        case 1:
                            appState = (_a.sent()).appState;
                            return [4 /*yield*/, client.getUser()];
                        case 2:
                            user = _a.sent();
                            onRedirectCallback(appState, user);
                            return [3 /*break*/, 6];
                        case 3: return [4 /*yield*/, client.checkSession()];
                        case 4:
                            _a.sent();
                            return [4 /*yield*/, client.getUser()];
                        case 5:
                            user = _a.sent();
                            _a.label = 6;
                        case 6:
                            dispatch({ type: 'INITIALISED', user: user });
                            return [3 /*break*/, 8];
                        case 7:
                            error_1 = _a.sent();
                            dispatch({ type: 'ERROR', error: loginError(error_1) });
                            return [3 /*break*/, 8];
                        case 8: return [2 /*return*/];
                    }
                });
            }); })();
        }, [client, onRedirectCallback, skipRedirectCallback]);
        var connectWithRedirect = React.useCallback(function (opts) {
            deprecateRedirectUri(opts);
            return client.connectWithRedirect(opts);
        }, [client]);
        var connectWithPopup = React.useCallback(function (options, config) { return __awaiter(void 0, void 0, void 0, function () {
            var error_2, user;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        dispatch({ type: 'LOGIN_POPUP_STARTED' });
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 3, , 4]);
                        return [4 /*yield*/, client.connectWithPopup(options, config)];
                    case 2:
                        _a.sent();
                        return [3 /*break*/, 4];
                    case 3:
                        error_2 = _a.sent();
                        dispatch({ type: 'ERROR', error: loginError(error_2) });
                        return [2 /*return*/];
                    case 4: return [4 /*yield*/, client.getUser()];
                    case 5:
                        user = _a.sent();
                        dispatch({ type: 'LOGIN_POPUP_COMPLETE', user: user });
                        return [2 /*return*/];
                }
            });
        }); }, [client]);
        var logout = React.useCallback(function (opts) {
            if (opts === void 0) { opts = {}; }
            return __awaiter(void 0, void 0, void 0, function () {
                return __generator(this, function (_a) {
                    switch (_a.label) {
                        case 0: return [4 /*yield*/, client.logout(opts)];
                        case 1:
                            _a.sent();
                            dispatch({ type: 'LOGOUT' });
                            return [2 /*return*/];
                    }
                });
            });
        }, [client]);
        var getUser = React.useCallback(function () { return client.getUser(); }, [client]);
        var getIdToken = React.useCallback(function () { return client.getIdToken(); }, [client]);
        var handleRedirectCallback = React.useCallback(function (url) { return __awaiter(void 0, void 0, void 0, function () {
            var error_3, _a;
            var _b;
            return __generator(this, function (_c) {
                switch (_c.label) {
                    case 0:
                        _c.trys.push([0, 2, 3, 5]);
                        return [4 /*yield*/, client.handleRedirectCallback(url)];
                    case 1: return [2 /*return*/, _c.sent()];
                    case 2:
                        error_3 = _c.sent();
                        throw tokenError(error_3);
                    case 3:
                        _a = dispatch;
                        _b = {
                            type: 'HANDLE_REDIRECT_COMPLETE'
                        };
                        return [4 /*yield*/, client.getUser()];
                    case 4:
                        _a.apply(void 0, [(_b.user = _c.sent(),
                                _b)]);
                        return [7 /*endfinally*/];
                    case 5: return [2 /*return*/];
                }
            });
        }); }, [client]);
        var contextValue = React.useMemo(function () {
            return __assign(__assign({}, state), { getUser: getUser, getIdToken: getIdToken, connectWithRedirect: connectWithRedirect, connectWithPopup: connectWithPopup, logout: logout, handleRedirectCallback: handleRedirectCallback });
        }, [
            state,
            getUser,
            getIdToken,
            connectWithRedirect,
            connectWithPopup,
            logout,
            handleRedirectCallback,
        ]);
        return React.createElement(context.Provider, { value: contextValue }, children);
    };

    /**
     * ```js
     * const {
     *   // Auth state:
     *   error,
     *   isConnected,
     *   isLoading,
     *   user,
     *   // Auth methods:
     *   getAccessTokenSilently,
     *   getAccessTokenWithPopup,
     *   getIdToken,
     *   connectWithRedirect,
     *   connectWithPopup,
     *   logout,
     * } = useEarthoOne<TUser>();
     * ```
     *
     * Use the `useEarthoOne` hook in your components to access the auth state and methods.
     *
     * TUser is an optional type param to provide a type to the `user` field.
     */
    var useEarthoOne = function (context) {
        if (context === void 0) { context = EarthoOneContext; }
        return React.useContext(context);
    };

    /**
     * ```jsx
     * class MyComponent extends Component {
     *   render() {
     *     // Access the auth context from the `eartho` prop
     *     const { user } = this.props.eartho;
     *     return <div>Hello {user.name}!</div>
     *   }
     * }
     * // Wrap your class component in withEarthoOne
     * export default withEarthoOne(MyComponent);
     * ```
     *
     * Wrap your class components in this Higher Order Component to give them access to the EarthoOneContext.
     *
     * Providing a context as the second argument allows you to configure the EarthoOneProvider the EarthoOneContext
     * should come from f you have multiple within your application.
     */
    var withEarthoOne = function (Component, context) {
        if (context === void 0) { context = EarthoOneContext; }
        return function WithAuth(props) {
            return (React.createElement(context.Consumer, null, function (auth) { return (React.createElement(Component, __assign({}, props, { eartho: auth }))); }));
        };
    };

    /**
     * @ignore
     */
    var defaultOnRedirecting = function () { return React.createElement(React.Fragment, null); };
    /**
    * @ignore
    */
    var defaultOnBeforeAuthentication = function () { return __awaiter(void 0, void 0, void 0, function () { return __generator(this, function (_a) {
        return [2 /*return*/];
    }); }); };
    /**
     * @ignore
     */
    var defaultReturnTo = function () {
        return "".concat(window.location.pathname).concat(window.location.search);
    };
    /**
     * ```js
     * const MyProtectedComponent = withAuthenticationRequired(MyComponent);
     * ```
     *
     * When you wrap your components in this Higher Order Component and an anonymous user visits your component
     * they will be redirected to the login page; after login they will be returned to the page they were redirected from.
     */
    var withAuthenticationRequired = function (Component, options) {
        return function WithAuthenticationRequired(props) {
            var _this = this;
            var _a = options.returnTo, returnTo = _a === void 0 ? defaultReturnTo : _a, _b = options.onRedirecting, onRedirecting = _b === void 0 ? defaultOnRedirecting : _b, _c = options.onBeforeAuthentication, onBeforeAuthentication = _c === void 0 ? defaultOnBeforeAuthentication : _c, loginOptions = options.loginOptions, _d = options.context, context = _d === void 0 ? EarthoOneContext : _d;
            var _e = useEarthoOne(context), isConnected = _e.isConnected, isLoading = _e.isLoading, connectWithRedirect = _e.connectWithRedirect;
            React.useEffect(function () {
                if (isLoading || isConnected) {
                    return;
                }
                var opts = __assign(__assign({}, loginOptions), { appState: __assign(__assign({}, (loginOptions && loginOptions.appState)), { returnTo: typeof returnTo === 'function' ? returnTo() : returnTo }) });
                (function () { return __awaiter(_this, void 0, void 0, function () {
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0: return [4 /*yield*/, onBeforeAuthentication()];
                            case 1:
                                _a.sent();
                                return [4 /*yield*/, connectWithRedirect(opts)];
                            case 2:
                                _a.sent();
                                return [2 /*return*/];
                        }
                    });
                }); })();
            }, [
                isLoading,
                isConnected,
                connectWithRedirect,
                onBeforeAuthentication,
                loginOptions,
                returnTo,
            ]);
            return isConnected ? React.createElement(Component, __assign({}, props)) : onRedirecting();
        };
    };

    exports.AuthenticationError = AuthenticationError;
    exports.EarthoOneContext = EarthoOneContext;
    exports.EarthoOneProvider = EarthoOneProvider;
    exports.GenericError = GenericError;
    exports.InMemoryCache = InMemoryCache;
    exports.LocalStorageCache = LocalStorageCache;
    exports.MfaRequiredError = MfaRequiredError;
    exports.OAuthError = OAuthError;
    exports.PopupCancelledError = PopupCancelledError;
    exports.PopupTimeoutError = PopupTimeoutError;
    exports.TimeoutError = TimeoutError;
    exports.User = User;
    exports.initialContext = initialContext;
    exports.useEarthoOne = useEarthoOne;
    exports.withAuthenticationRequired = withAuthenticationRequired;
    exports.withEarthoOne = withEarthoOne;

}));
//# sourceMappingURL=one-client-react.js.map
